services:
  # MySQL数据库
  mysql:
    image: mysql:8.0
    container_name: cpm-mysql
    environment:
      MYSQL_ROOT_PASSWORD: 123456
      MYSQL_DATABASE: cpm_db
      TZ: Asia/Shanghai
    ports:
      - "3307:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./cpm-gateway/src/main/resources/static/sql/nacos-mysql.sql:/docker-entrypoint-initdb.d/01-nacos-mysql.sql
      - ./cpm-gateway/src/main/resources/static/sql/cpm_db.sql:/docker-entrypoint-initdb.d/02-cpm_db.sql
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    networks:
      - cpm-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis缓存
  redis:
    image: redis:7-alpine
    container_name: cpm-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    networks:
      - cpm-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # RabbitMQ消息队列
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: cpm-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - cpm-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Elasticsearch搜索引擎
  elasticsearch:
    image: elasticsearch:7.17.9
    container_name: cpm-elasticsearch
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - xpack.security.enabled=false
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    networks:
      - cpm-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Nacos服务注册中心
  nacos:
    image: nacos/nacos-server:v2.2.3
    container_name: cpm-nacos
    environment:
      MODE: standalone
      SPRING_DATASOURCE_PLATFORM: mysql
      MYSQL_SERVICE_HOST: mysql
      MYSQL_SERVICE_PORT: 3306
      MYSQL_SERVICE_DB_NAME: nacos_config
      MYSQL_SERVICE_USER: root
      MYSQL_SERVICE_PASSWORD: 123456
      MYSQL_SERVICE_DB_PARAM: characterEncoding=utf8&connectTimeout=1000&socketTimeout=3000&autoReconnect=true&useSSL=false&allowPublicKeyRetrieval=true
      NACOS_AUTH_ENABLE: false
    ports:
      - "8848:8848"
      - "9848:9848"
    depends_on:
      mysql:
        condition: service_healthy
    volumes:
      - nacos_data:/home/nacos/logs
    networks:
      - cpm-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8848/nacos/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 10

  # Zipkin 分布式追踪服务
  zipkin:
    image: openzipkin/zipkin-slim:2.24.1
    container_name: cpm-zipkin
    ports:
      - "9411:9411"
    environment:
      STORAGE_TYPE: mem
    networks:
      - cpm-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9411/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Sentinel Dashboard 流量控制服务
  sentinel:
    image: bladex/sentinel-dashboard:1.8.8
    container_name: cpm-sentinel
    ports:
      - "8858:8858"
    environment:
      JAVA_OPTS: "-Dserver.port=8858 -Dcsp.sentinel.dashboard.server=localhost:8858 -Dproject.name=sentinel-dashboard"
    networks:
      - cpm-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8858/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  # 行政区划数据服务
  regions-data:
    build:
      context: ./regions_data-main
      dockerfile: Dockerfile
    container_name: cpm-regions-data
    ports:
      - "8000:8000"
    environment:
      HOST: "0.0.0.0"
      PORT: "8000"
      RELOAD: "false"
      ZIPKIN_BASE_URL: ${ZIPKIN_BASE_URL:-http://zipkin:9411}
      ZIPKIN_SAMPLE_RATE: ${ZIPKIN_SAMPLE_RATE:-1.0}
    volumes:
      - ./regions_data-main/regions.db:/app/regions.db
    networks:
      - cpm-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/api/provinces || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  # 用户服务
  user-service:
    build:
      context: .
      dockerfile: Dockerfile.user-service
    container_name: cpm-user-service
    ports:
      - "8081:8081"
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/cpm_db?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: 123456
      SPRING_REDIS_HOST: redis
      SPRING_REDIS_PORT: 6379
      SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR: nacos:8848
      SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR: nacos:8848
      REGIONS_API_BASE_URL: http://regions-data:8000
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      nacos:
        condition: service_healthy
    networks:
      - cpm-network

  # 文件服务
  file-service:
    build:
      context: .
      dockerfile: Dockerfile.file-service
    container_name: cpm-file-service
    ports:
      - "8086:8086"
    environment:
      SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR: nacos:8848
      SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR: nacos:8848
      FILE_UPLOAD_PATH: /app/uploads
      FILE_UPLOAD_URL_PREFIX: /uploads
    depends_on:
      nacos:
        condition: service_healthy
    networks:
      - cpm-network
    volumes:
      - ./uploads:/app/uploads

  # 通知服务
  notification-service:
    build:
      context: .
      dockerfile: Dockerfile.notification-service
    container_name: cpm-notification-service
    ports:
      - "8087:8087"
    environment:
      SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR: nacos:8848
      SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR: nacos:8848
      REDIS_HOST: redis
      REDIS_PORT: 6379
      MAIL_HOST: ${MAIL_HOST:-smtp.qq.com}
      MAIL_PORT: ${MAIL_PORT:-587}
      MAIL_USERNAME: ${MAIL_USERNAME:-3357276026@qq.com}
      MAIL_PASSWORD: ${MAIL_PASSWORD:-zubjafvksuqxcjhh}
      MAIL_FROM: ${MAIL_FROM:-3357276026@qq.com}
    depends_on:
      nacos:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - cpm-network

  # 居民服务
  resident-service:
    build:
      context: .
      dockerfile: Dockerfile.resident-service
    container_name: cpm-resident-service
    ports:
      - "8082:8082"
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/cpm_db?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: 123456
      SPRING_REDIS_HOST: redis
      SPRING_REDIS_PORT: 6379
      SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR: nacos:8848
      SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR: nacos:8848
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      nacos:
        condition: service_healthy
    networks:
      - cpm-network

  # 户籍服务
  household-service:
    build:
      context: .
      dockerfile: Dockerfile.household-service
    container_name: cpm-household-service
    ports:
      - "8083:8083"
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/cpm_db?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: 123456
      SPRING_REDIS_HOST: redis
      SPRING_REDIS_PORT: 6379
      SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR: nacos:8848
      SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR: nacos:8848
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      nacos:
        condition: service_healthy
    networks:
      - cpm-network

  # 统计服务
  statistics-service:
    build:
      context: .
      dockerfile: Dockerfile.statistics-service
    container_name: cpm-statistics-service
    ports:
      - "8084:8084"
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/cpm_db?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: 123456
      SPRING_REDIS_HOST: redis
      SPRING_REDIS_PORT: 6379
      SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR: nacos:8848
      SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR: nacos:8848
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      nacos:
        condition: service_healthy
    networks:
      - cpm-network

  # 搜索服务
  search-service:
    build:
      context: .
      dockerfile: Dockerfile.search-service
    container_name: cpm-search-service
    ports:
      - "8085:8085"
    environment:
      SPRING_ELASTICSEARCH_URIS: http://elasticsearch:9200
      SPRING_REDIS_HOST: redis
      SPRING_REDIS_PORT: 6379
      SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR: nacos:8848
      SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR: nacos:8848
    depends_on:
      elasticsearch:
        condition: service_healthy
      redis:
        condition: service_healthy
      nacos:
        condition: service_healthy
    networks:
      - cpm-network

  # API网关
  gateway:
    build:
      context: .
      dockerfile: Dockerfile.gateway
    container_name: cpm-gateway
    ports:
      - "8080:8080"
    environment:
      SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR: nacos:8848
      SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR: nacos:8848
      FILE_UPLOAD_PATH: /app/uploads
      FILE_UPLOAD_URL_PREFIX: /uploads
    depends_on:
      user-service:
        condition: service_started
      resident-service:
        condition: service_started
      file-service:
        condition: service_started
      notification-service:
        condition: service_started
      household-service:
        condition: service_started
      statistics-service:
        condition: service_started
      search-service:
        condition: service_started
      nacos:
        condition: service_healthy
    networks:
      - cpm-network
    volumes:
      - ./uploads:/app/uploads

  # 前端服务
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: cpm-frontend
    ports:
      - "3000:80"
    depends_on:
      gateway:
        condition: service_started
    networks:
      - cpm-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

networks:
  cpm-network:
    driver: bridge

volumes:
  mysql_data:
  redis_data:
  rabbitmq_data:
  elasticsearch_data:
  nacos_data:
