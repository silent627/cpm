# CPM系统微服务拆分建议

基于当前代码分析，以下是可提取为独立微服务的功能模块：

## 1. 通知服务 (cpm-notification-service) ⭐⭐⭐

### 功能范围
- **邮件服务**：发送邮件、验证码邮件
- **短信服务**：发送短信验证码（未来扩展）
- **站内消息**：系统通知、消息推送
- **验证码管理**：邮箱验证码、短信验证码的统一管理

### 当前代码位置
- `cpm-user-service/.../service/EmailService.java`
- `cpm-user-service/.../service/EmailCodeService.java`
- `cpm-user-service/.../service/impl/EmailServiceImpl.java`
- `cpm-user-service/.../service/impl/EmailCodeServiceImpl.java`

### 优势
- ✅ 邮件发送逻辑独立，便于统一管理
- ✅ 验证码生成、存储、验证逻辑集中
- ✅ 易于扩展短信、推送等通知方式
- ✅ 可以统一配置邮件服务器、短信服务商

### 接口设计
```
POST /notification/email/send          # 发送邮件
POST /notification/email/code/send     # 发送邮箱验证码
POST /notification/email/code/verify   # 验证邮箱验证码
POST /notification/sms/send            # 发送短信（未来）
POST /notification/message/send        # 发送站内消息（未来）
```

---

## 2. 验证码服务 (cpm-captcha-service) ⭐⭐

### 功能范围
- **图形验证码**：生成、验证图形验证码
- **验证码管理**：验证码存储、过期管理
- **防刷机制**：IP限流、验证码复杂度控制

### 当前代码位置
- `cpm-user-service/.../service/CaptchaService.java`
- `cpm-user-service/.../service/impl/CaptchaServiceImpl.java`

### 优势
- ✅ 验证码逻辑独立，便于统一管理
- ✅ 可以统一配置验证码样式、复杂度
- ✅ 易于扩展其他类型验证码（滑动验证、行为验证等）

### 接口设计
```
GET  /captcha/generate                 # 生成图形验证码
POST /captcha/verify                   # 验证验证码
GET  /captcha/refresh                  # 刷新验证码
```

---

## 3. Excel服务 (cpm-excel-service) ⭐⭐⭐

### 功能范围
- **Excel导出**：用户、居民、户籍等数据导出
- **Excel导入**：批量导入数据、数据校验
- **模板管理**：导入模板生成、下载
- **数据转换**：DTO转换、数据格式化

### 当前代码位置
- `cpm-user-service/.../service/ExcelExportService.java`
- `cpm-resident-service/.../service/ExcelExportService.java`

### 优势
- ✅ Excel操作逻辑重复，统一管理减少代码冗余
- ✅ 可以统一处理Excel格式、样式、数据校验
- ✅ 易于扩展其他格式（CSV、PDF等）
- ✅ 可以统一处理大数据量导出（异步导出）

### 接口设计
```
POST /excel/export                     # 导出Excel
POST /excel/import                     # 导入Excel
GET  /excel/template/{type}            # 下载导入模板
POST /excel/validate                   # 验证Excel数据
GET  /excel/export/status/{taskId}     # 查询导出任务状态（异步导出）
```

---

## 4. 缓存服务 (cpm-cache-service) ⭐⭐

### 功能范围
- **缓存管理**：统一缓存操作接口
- **缓存策略**：缓存过期、刷新策略
- **缓存监控**：缓存命中率、性能监控
- **分布式锁**：基于Redis的分布式锁

### 当前代码位置
- `cpm-common/.../util/RedisUtil.java`（各服务都在使用）

### 优势
- ✅ 缓存逻辑集中，便于统一管理
- ✅ 可以统一配置缓存策略、过期时间
- ✅ 易于扩展缓存类型（本地缓存、分布式缓存）
- ✅ 可以统一监控缓存性能

### 接口设计
```
GET  /cache/get/{key}                  # 获取缓存
POST /cache/set                        # 设置缓存
DELETE /cache/delete/{key}             # 删除缓存
POST /cache/batch/delete               # 批量删除缓存
GET  /cache/stats                      # 缓存统计信息
POST /cache/lock                       # 获取分布式锁
POST /cache/unlock                     # 释放分布式锁
```

---

## 5. 日志服务 (cpm-log-service) ⭐

### 功能范围
- **操作日志**：记录增删改操作
- **审计日志**：记录敏感操作、数据变更
- **日志查询**：日志检索、统计分析
- **日志归档**：日志存储、归档策略

### 当前状态
- 目前没有统一的日志服务，各服务自行记录日志

### 优势
- ✅ 统一日志格式、存储
- ✅ 便于日志查询、分析
- ✅ 可以统一配置日志级别、归档策略
- ✅ 支持日志审计、合规要求

### 接口设计
```
POST /log/record                       # 记录操作日志
GET  /log/query                        # 查询日志
GET  /log/audit                        # 审计日志查询
POST /log/export                       # 导出日志
```

---

## 6. 配置服务 (cpm-config-service) ⭐

### 功能范围
- **系统配置**：系统参数配置管理
- **字典管理**：数据字典维护
- **配置热更新**：配置变更通知
- **多环境配置**：开发、测试、生产环境配置

### 当前状态
- 目前使用Nacos配置中心，但缺少统一的配置管理服务

### 优势
- ✅ 统一配置管理，便于维护
- ✅ 支持配置热更新，无需重启
- ✅ 可以统一管理数据字典
- ✅ 支持配置版本管理、回滚

### 接口设计
```
GET  /config/get/{key}                 # 获取配置
POST /config/set                       # 设置配置
GET  /config/dict/{type}               # 获取数据字典
POST /config/dict/update               # 更新数据字典
GET  /config/refresh                    # 刷新配置缓存
```

---

## 优先级建议

### 高优先级（建议优先实现）
1. **Excel服务** ⭐⭐⭐
   - 代码重复度高（user和resident服务都有）
   - 功能相对独立
   - 易于拆分和迁移

2. **通知服务** ⭐⭐⭐
   - 邮件服务已相对独立
   - 验证码逻辑可以统一管理
   - 便于扩展其他通知方式

### 中优先级（后续考虑）
3. **验证码服务** ⭐⭐
   - 功能相对简单
   - 可以独立部署
   - 便于统一管理验证码策略

4. **缓存服务** ⭐⭐
   - 各服务都在使用RedisUtil
   - 可以统一管理缓存策略
   - 但需要考虑性能影响

### 低优先级（可选）
5. **日志服务** ⭐
   - 目前日志分散在各服务
   - 可以逐步迁移

6. **配置服务** ⭐
   - 目前使用Nacos已满足需求
   - 可以后续优化

---

## 实施建议

### 阶段一：Excel服务拆分
1. 创建 `cpm-excel-service` 模块
2. 迁移 `ExcelExportService` 相关代码
3. 更新 `user-service` 和 `resident-service` 使用Feign调用
4. 测试验证

### 阶段二：通知服务拆分
1. 创建 `cpm-notification-service` 模块
2. 迁移邮件服务、验证码服务
3. 更新 `user-service` 使用Feign调用
4. 测试验证

### 阶段三：其他服务拆分
1. 根据实际需求逐步拆分其他服务
2. 评估拆分带来的收益和成本
3. 优化服务间通信

---

## 注意事项

1. **服务拆分成本**
   - 增加服务间通信开销
   - 增加部署复杂度
   - 需要处理分布式事务

2. **拆分原则**
   - 功能相对独立
   - 代码重复度高
   - 易于测试和维护
   - 拆分收益大于成本

3. **技术考虑**
   - 使用Feign进行服务间调用
   - 考虑服务降级、熔断
   - 统一异常处理
   - 统一日志格式

---

## 总结

建议优先拆分 **Excel服务** 和 **通知服务**，这两个服务功能相对独立，代码重复度高，拆分后可以显著减少代码冗余，提高系统可维护性。
