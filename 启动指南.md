# CPM系统启动指南

## 📋 目录
1. [环境要求](#环境要求)
2. [数据库配置](#数据库配置)
3. [Redis配置](#redis配置)
4. [启动regions_data服务](#启动regions_data服务)
5. [启动后端服务](#启动后端服务)
6. [启动前端服务](#启动前端服务)
7. [访问系统](#访问系统)
8. [常见问题](#常见问题)

---

## 环境要求

### 必需环境
- **JDK**: 1.8 或更高版本
- **Maven**: 3.6 或更高版本
- **MySQL**: 8.0 或更高版本
- **Redis**: 6.0 或更高版本
- **Node.js**: 16.0 或更高版本
- **npm**: 8.0 或更高版本
- **Python**: 3.8 或更高版本（用于regions_data服务）

### 可选环境
- **IDE**: IntelliJ IDEA / Eclipse / VS Code
- **数据库管理工具**: Navicat / DBeaver / MySQL Workbench

---

## 数据库配置

### 1. 创建数据库

```sql
CREATE DATABASE cpm_db DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

### 2. 执行初始化脚本

使用MySQL客户端执行SQL脚本：

```bash
# Windows (在项目根目录下)
mysql -u root -p cpm_db < src\main\resources\sql\complete_database.sql

# Linux/Mac (在项目根目录下)
mysql -u root -p cpm_db < src/main/resources/sql/complete_database.sql
```

或者使用数据库管理工具（如Navicat）直接执行 `src/main/resources/sql/complete_database.sql` 文件。

### 3. 修改数据库配置

编辑 `src/main/resources/application.properties` 文件，修改数据库连接信息：

```properties
# 数据库配置
spring.datasource.url=jdbc:mysql://localhost:3306/cpm_db?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
spring.datasource.username=root
spring.datasource.password=你的数据库密码
```

---

## Redis配置

### 1. 启动Redis服务

**Windows:**
```bash
# 如果使用Redis for Windows，直接运行redis-server.exe
redis-server.exe
```

**Linux/Mac:**
```bash
# 启动Redis服务
redis-server

# 或者使用systemd（如果已安装为服务）
sudo systemctl start redis
```

### 2. 验证Redis运行

```bash
# 测试Redis连接
redis-cli ping
# 应该返回: PONG
```

### 3. 修改Redis配置（如需要）

编辑 `src/main/resources/application.properties` 文件：

```properties
# Redis配置
spring.redis.host=localhost
spring.redis.port=6379
spring.redis.database=0
# 如果Redis设置了密码，取消下面的注释并填写密码
# spring.redis.password=你的Redis密码
```

---

## 启动regions_data服务

### 1. 安装Python依赖

```bash
# 进入regions_data目录
cd regions_data-main

# 安装依赖
pip install -r requirements.txt
```

### 2. 启动服务

```bash
# 方式1：使用uvicorn命令
python -m uvicorn api.index:app --host 127.0.0.1 --port 8000 --reload

# 方式2：使用main.py（如果配置了）
python main.py
```

### 3. 验证服务

打开浏览器访问：http://127.0.0.1:8000

应该能看到regions_data的API文档页面。

### 4. 修改配置（如需要）

如果regions_data服务运行在不同端口，需要修改 `src/main/resources/application.properties`：

```properties
# 行政区划服务配置
regions.api.base-url=http://127.0.0.1:8000
```

---

## 启动后端服务

### 方式1：使用Maven命令（推荐）

```bash
# 在项目根目录下执行

# 1. 清理并编译项目
mvn clean install

# 2. 启动Spring Boot应用
mvn spring-boot:run
```

### 方式2：使用IDE启动

1. 使用IntelliJ IDEA或Eclipse打开项目
2. 找到主类：`com.wuzuhao.cpm.CpmApplication`
3. 右键选择"Run"或"Debug"

### 方式3：打包后运行

```bash
# 1. 打包项目
mvn clean package

# 2. 运行jar包
java -jar target/cpm-0.0.1-SNAPSHOT.jar
```

### 验证后端启动

- 后端服务默认运行在：http://localhost:8080
- API文档（Knife4j）：http://localhost:8080/doc.html
- 健康检查：http://localhost:8080/api/health（如果有）

---

## 启动前端服务

### 1. 安装依赖

```bash
# 进入前端目录
cd src/main/resources/frontend

# 安装npm依赖
npm install
```

### 2. 启动开发服务器

```bash
# 启动Vite开发服务器
npm run dev
```

### 3. 验证前端启动

前端服务运行在：http://localhost:3000（配置在vite.config.js中）

---

## 访问系统

### 1. 前端访问地址

- **开发环境**: http://localhost:3000
- **生产环境**: http://localhost:8080（如果配置了静态资源）

### 2. 默认账号

- **管理员账号**:
  - 用户名: `admin`
  - 密码: `admin123`
  - 角色: ADMIN

### 3. API文档

- **Knife4j文档**: http://localhost:8080/doc.html
- **Swagger文档**: http://localhost:8080/swagger-ui.html

---

## 启动顺序总结

### 完整启动流程

```bash
# 1. 启动MySQL数据库
# （确保MySQL服务已启动）

# 2. 启动Redis服务
redis-server

# 3. 启动regions_data服务（新终端窗口）
cd regions_data-main
python -m uvicorn api.index:app --host 127.0.0.1 --port 8000 --reload

# 4. 启动后端服务（新终端窗口）
cd "E:\Graduation Project\cpm"
mvn spring-boot:run

# 5. 启动前端服务（新终端窗口）
cd src/main/resources/frontend
npm run dev
```

### 快速启动脚本（Windows）

创建 `start.bat` 文件：

```batch
@echo off
echo 启动CPM系统...

echo [1/5] 检查MySQL服务...
net start MySQL80

echo [2/5] 启动Redis服务...
start "Redis" redis-server.exe

echo [3/5] 启动regions_data服务...
start "Regions Data" cmd /k "cd regions_data-main && python -m uvicorn api.index:app --host 127.0.0.1 --port 8000 --reload"

echo [4/5] 启动后端服务...
start "CPM Backend" cmd /k "mvn spring-boot:run"

timeout /t 10

echo [5/5] 启动前端服务...
start "CPM Frontend" cmd /k "cd src\main\resources\frontend && npm run dev"

echo 所有服务启动完成！
echo 前端地址: http://localhost:3000
echo 后端地址: http://localhost:8080
echo API文档: http://localhost:8080/doc.html
pause
```

### 快速启动脚本（Linux/Mac）

创建 `start.sh` 文件：

```bash
#!/bin/bash

echo "启动CPM系统..."

echo "[1/5] 检查MySQL服务..."
sudo systemctl start mysql

echo "[2/5] 启动Redis服务..."
redis-server &
REDIS_PID=$!

echo "[3/5] 启动regions_data服务..."
cd regions_data-main
python -m uvicorn api.index:app --host 127.0.0.1 --port 8000 --reload &
REGIONS_PID=$!
cd ..

echo "[4/5] 启动后端服务..."
mvn spring-boot:run &
BACKEND_PID=$!

sleep 10

echo "[5/5] 启动前端服务..."
cd src/main/resources/frontend
npm run dev &
FRONTEND_PID=$!
cd ../../../../..

echo "所有服务启动完成！"
echo "前端地址: http://localhost:3000"
echo "后端地址: http://localhost:8080"
echo "API文档: http://localhost:8080/doc.html"
echo ""
echo "按Ctrl+C停止所有服务"

# 等待中断信号
trap "kill $REDIS_PID $REGIONS_PID $BACKEND_PID $FRONTEND_PID; exit" INT
wait
```

---

## 常见问题

### 1. 数据库连接失败

**问题**: `java.sql.SQLException: Access denied for user`

**解决方案**:
- 检查 `application.properties` 中的数据库用户名和密码
- 确认MySQL服务已启动
- 确认数据库 `cpm_db` 已创建

### 2. Redis连接失败

**问题**: `Unable to connect to Redis`

**解决方案**:
- 确认Redis服务已启动：`redis-cli ping`
- 检查Redis端口是否为6379
- 如果Redis设置了密码，在配置文件中添加密码

### 3. regions_data服务无法访问

**问题**: 地址级联选择器显示"加载失败"

**解决方案**:
- 确认regions_data服务已启动：访问 http://127.0.0.1:8000
- 检查 `application.properties` 中的 `regions.api.base-url` 配置
- 确认Python依赖已安装：`pip install -r requirements.txt`

### 4. 前端无法连接后端

**问题**: 前端请求返回404或网络错误

**解决方案**:
- 确认后端服务已启动：访问 http://localhost:8080/doc.html
- 检查前端 `vite.config.js` 中的代理配置
- 检查后端CORS配置

### 5. 端口被占用

**问题**: `Port 8080 is already in use`

**解决方案**:
- 修改 `application.properties` 中的端口：
  ```properties
  server.port=8081
  ```
- 或者关闭占用端口的进程

### 6. Maven依赖下载失败

**问题**: `Could not transfer artifact`

**解决方案**:
- 检查网络连接
- 配置Maven镜像（推荐使用阿里云镜像）
- 清理Maven缓存：`mvn clean`

### 7. npm依赖安装失败

**问题**: `npm ERR!`

**解决方案**:
- 使用国内镜像：
  ```bash
  npm config set registry https://registry.npmmirror.com
  ```
- 删除 `node_modules` 和 `package-lock.json`，重新安装
- 检查Node.js版本是否符合要求

---

## 系统架构

```
┌─────────────────┐
│   前端 (Vue3)   │  http://localhost:3000
│   Vite Dev      │
└────────┬────────┘
         │ HTTP请求
         ▼
┌─────────────────┐
│ 后端 (Spring)   │  http://localhost:8080
│  Spring Boot    │
└────────┬────────┘
         │
    ┌────┴────┬──────────┬──────────┐
    ▼         ▼          ▼          ▼
┌────────┐ ┌──────┐ ┌─────────┐ ┌──────────┐
│ MySQL  │ │Redis │ │regions_ │ │文件存储  │
│ :3306  │ │:6379 │ │data:8000│ │uploads/ │
└────────┘ └──────┘ └─────────┘ └──────────┘
```

---

## 开发模式说明

### 后端开发
- 使用 `mvn spring-boot:run` 启动，支持热重载
- 修改Java代码后需要重启服务
- 日志输出在控制台

### 前端开发
- 使用 `npm run dev` 启动Vite开发服务器
- 支持热模块替换（HMR），修改代码自动刷新
- 代理配置在 `vite.config.js` 中

### 生产部署
- 后端：`mvn clean package` 打包为jar文件
- 前端：`npm run build` 构建静态文件
- 将前端构建文件复制到 `src/main/resources/static/` 目录

---

## 联系与支持

如有问题，请查看：
- 项目README.md
- API文档：http://localhost:8080/doc.html
- 日志文件：检查控制台输出

---

**祝使用愉快！** 🎉

