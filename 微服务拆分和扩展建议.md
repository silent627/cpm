# 微服务拆分和扩展建议

## 当前微服务架构

### 已有服务
1. **cpm-gateway** - API网关（Spring Cloud Gateway）
2. **cpm-user-service** - 用户服务（用户、管理员、认证、邮件、验证码、行政区划）
3. **cpm-resident-service** - 居民服务（居民管理、文件上传）
4. **cpm-household-service** - 户籍服务（户籍管理、户籍成员）
5. **cpm-statistics-service** - 统计服务（数据统计、图表数据）
6. **cpm-search-service** - 搜索服务（Elasticsearch）
7. **cpm-common** - 公共模块

## 建议拆分的微服务

### 1. 文件服务（cpm-file-service）⭐ 高优先级

**当前状态**：文件上传功能在 `cpm-resident-service` 中

**拆分理由**：
- 文件管理是通用功能，多个服务都需要
- 可以统一管理文件存储策略（本地、OSS、MinIO等）
- 便于实现文件CDN、缩略图生成等功能
- 独立部署，便于扩展存储容量

**功能范围**：
- 文件上传（图片、文档等）
- 文件下载
- 文件删除
- 文件预览（图片预览、PDF预览）
- 文件存储管理（本地、OSS、MinIO）
- 文件访问权限控制

**技术栈**：
- Spring Boot + Spring Cloud
- 可选：MinIO（对象存储）、阿里云OSS、腾讯云COS

**端口建议**：8086

---

### 2. 通知服务（cpm-notification-service）⭐ 高优先级

**当前状态**：邮件服务在 `cpm-user-service` 中

**拆分理由**：
- 通知功能是通用能力（邮件、短信、站内信、推送）
- 可以统一管理通知渠道和模板
- 便于实现通知队列、重试机制
- 支持多种通知方式扩展

**功能范围**：
- 邮件通知（当前已有）
- 短信通知（可扩展）
- 站内消息（可扩展）
- 推送通知（可扩展）
- 通知模板管理
- 通知记录和统计

**技术栈**：
- Spring Boot + Spring Cloud
- Spring Mail（邮件）
- 阿里云短信、腾讯云短信（可选）
- RabbitMQ（消息队列）

**端口建议**：8087

---

### 3. 认证授权服务（cpm-auth-service）⭐ 中优先级

**当前状态**：认证逻辑在 `cpm-user-service` 中

**拆分理由**：
- 认证授权是独立的安全域
- 可以实现更细粒度的权限控制（RBAC、ABAC）
- 支持OAuth2、SSO等认证方式
- 便于实现多租户认证

**功能范围**：
- 用户登录/登出
- Token生成和验证
- 权限验证
- 角色管理
- 权限管理
- OAuth2支持（可选）
- SSO单点登录（可选）

**技术栈**：
- Spring Boot + Spring Cloud
- Spring Security（可选）
- JWT
- Redis（Token存储）

**端口建议**：8088

**注意**：拆分后，`cpm-user-service` 只负责用户信息管理，认证相关功能迁移到 `cpm-auth-service`

---

### 4. 日志服务（cpm-log-service）⭐ 中优先级

**当前状态**：各服务独立记录日志

**拆分理由**：
- 集中式日志收集和分析
- 便于问题排查和性能分析
- 支持日志查询、统计、告警

**功能范围**：
- 日志收集（各服务日志上报）
- 日志存储（Elasticsearch）
- 日志查询和检索
- 日志统计分析
- 日志告警
- 操作审计日志

**技术栈**：
- Spring Boot + Spring Cloud
- Elasticsearch（日志存储）
- Logstash（日志处理，可选）
- Kafka（日志队列，可选）

**端口建议**：8089

---

### 5. 监控服务（cpm-monitor-service）⭐ 中优先级

**当前状态**：无统一监控

**拆分理由**：
- 统一监控所有微服务
- 服务健康检查
- 性能指标收集
- 告警通知

**功能范围**：
- 服务健康检查
- 服务性能监控（CPU、内存、响应时间）
- 服务调用链追踪
- 告警规则配置
- 告警通知
- 监控大盘

**技术栈**：
- Spring Boot + Spring Cloud
- Prometheus（指标收集）
- Grafana（可视化，可选）
- Micrometer（指标采集）

**端口建议**：8090

---

### 6. 报表服务（cpm-report-service）⭐ 低优先级

**当前状态**：Excel导出功能分散在各服务中

**拆分理由**：
- 统一报表生成逻辑
- 支持多种报表格式（Excel、PDF、Word）
- 支持定时报表生成
- 报表模板管理

**功能范围**：
- Excel导出
- PDF导出
- Word导出
- 报表模板管理
- 定时报表生成
- 报表数据缓存

**技术栈**：
- Spring Boot + Spring Cloud
- EasyExcel（Excel处理）
- iText / Apache PDFBox（PDF处理）
- POI（Word处理）

**端口建议**：8091

---

### 7. 配置服务（cpm-config-service）⭐ 低优先级

**当前状态**：使用Nacos作为配置中心

**拆分理由**：
- 如果需要更复杂的配置管理
- 配置版本管理
- 配置审计
- 配置热更新

**注意**：如果Nacos已满足需求，可以不拆分

---

## 建议添加的微服务组件

### 1. 消息服务（cpm-message-service）

**功能**：
- 消息队列管理
- 消息路由
- 消息重试机制
- 死信队列处理

**技术栈**：
- Spring Boot + Spring Cloud
- RabbitMQ

**端口建议**：8092

---

### 2. 缓存服务（cpm-cache-service）

**功能**：
- 缓存策略管理
- 缓存预热
- 缓存监控
- 分布式缓存一致性

**技术栈**：
- Spring Boot + Spring Cloud
- Redis
- Redisson（可选）

**端口建议**：8093

---

### 3. 定时任务服务（cpm-schedule-service）

**功能**：
- 定时任务调度
- 任务管理
- 任务执行记录
- 任务失败重试

**技术栈**：
- Spring Boot + Spring Cloud
- XXL-Job / Quartz

**端口建议**：8094

---

## 拆分优先级建议

### 第一阶段（高优先级）
1. ✅ **文件服务（cpm-file-service）** - 文件管理是通用功能，多个服务都需要
2. ✅ **通知服务（cpm-notification-service）** - 邮件服务可以独立，便于扩展短信、推送等

### 第二阶段（中优先级）
3. **认证授权服务（cpm-auth-service）** - 如果权限系统复杂，建议拆分
4. **日志服务（cpm-log-service）** - 如果日志量大，需要集中管理
5. **监控服务（cpm-monitor-service）** - 生产环境建议添加

### 第三阶段（低优先级）
6. **报表服务（cpm-report-service）** - 如果报表需求复杂
7. **消息服务（cpm-message-service）** - 如果消息处理复杂
8. **缓存服务（cpm-cache-service）** - 如果缓存策略复杂
9. **定时任务服务（cpm-schedule-service）** - 如果定时任务多

---

## 拆分注意事项

### 1. 服务拆分原则
- **单一职责**：每个服务只负责一个业务域
- **高内聚低耦合**：服务内部功能紧密相关，服务之间依赖最小
- **数据独立**：每个服务有独立的数据库
- **接口稳定**：服务接口设计要考虑向后兼容

### 2. 拆分步骤
1. 分析当前功能，确定拆分边界
2. 创建新的微服务模块
3. 迁移相关代码和数据库表
4. 创建Feign客户端，实现服务间调用
5. 更新Gateway路由配置
6. 测试验证
7. 删除原服务中的相关代码

### 3. 拆分后的影响
- **服务数量增加**：需要管理更多服务
- **网络调用增加**：服务间调用需要网络通信
- **数据一致性**：需要考虑分布式事务
- **部署复杂度**：需要管理更多服务的部署

---

## 推荐拆分方案

### 最小拆分方案（推荐）
1. **文件服务（cpm-file-service）** - 文件管理独立
2. **通知服务（cpm-notification-service）** - 通知功能独立

### 完整拆分方案
1. 文件服务
2. 通知服务
3. 认证授权服务
4. 日志服务
5. 监控服务

---

## 下一步行动

1. **评估需求**：根据实际业务需求决定是否需要拆分
2. **选择优先级**：按照优先级逐步拆分
3. **制定计划**：制定详细的拆分计划和时间表
4. **逐步实施**：按照计划逐步实施拆分

---

## 总结

当前微服务架构已经比较完善，主要可以优化的方向是：
1. **文件服务独立** - 提高文件管理的通用性和可扩展性
2. **通知服务独立** - 支持多种通知方式，便于扩展
3. **认证授权独立** - 如果权限系统复杂，建议独立
4. **监控和日志** - 生产环境建议添加

建议先实施**文件服务**和**通知服务**的拆分，这两个服务拆分后可以显著提高系统的可维护性和可扩展性。

